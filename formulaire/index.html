<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Comit√© de soutien ‚Äì #Agir et Mieux Vivre 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<main>
  <h1>Comit√© de soutien ‚Äì Liste #Agir et Mieux Vivre 2026</h1>
  <p>√âlections municipales de mars 2026</p>

  <form id="support-form">

    <fieldset>
      <legend>Identit√©</legend>

      <div>
        <label for="last_name">Nom *</label><br>
        <input type="text" id="last_name" name="last_name" required>
      </div>

      <div>
        <label for="first_name">Pr√©nom *</label><br>
        <input type="text" id="first_name" name="first_name" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Coordonn√©es</legend>

      <div>
        <label for="address">Adresse *</label><br>
        <textarea id="address" name="address" rows="2" required></textarea>
      </div>

      <div>
        <label for="phone">T√©l√©phone *</label><br>
        <input type="tel" id="phone" name="phone" required>
      </div>

      <div>
        <label for="email">Courriel *</label><br>
        <input type="email" id="email" name="email" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Engagement</legend>

      <p>
        Je, soussign√©(e), souhaite participer au Comit√© de soutien de la liste
        <strong>#Agir et Mieux Vivre 2026</strong> pour les √©lections municipales de 2026.
      </p>

      <div>
        <input type="checkbox" id="public_name" name="public_name" value="yes" required>
        <label for="public_name">
          Par ma signature, j'accepte de figurer sur la liste des membres du comit√© de soutien.
          Seul mon nom y sera mentionn√©.
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Signature √©lectronique</legend>

      <p>En saisissant votre nom ci-dessous, vous validez votre engagement et votre identit√©.</p>

      <div>
        <label for="signature">Signature (Nom / Pr√©nom) *</label><br>
        <input type="text" id="signature" name="signature" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Mentions RGPD</legend>

      <p>
        Les informations recueillies sont n√©cessaires √† la gestion du comit√© de soutien de la liste
        #Agir et Mieux Vivre 2026. Conform√©ment au RGPD, vous pouvez exercer vos droits
        (acc√®s, rectification, suppression) en √©crivant √† :
        <strong>[adresse email de contact]</strong>.
      </p>

      <div>
        <input type="checkbox" id="rgpd_ok" name="rgpd_ok" value="yes" required>
        <label for="rgpd_ok">J‚Äôaccepte le traitement de mes donn√©es conform√©ment au RGPD.</label>
      </div>
    </fieldset>

    <button type="submit">Envoyer</button>
  </form>

  <p id="status"></p>
</main>

<!-- SUPABASE + LOGIQUE -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>

  // --------------------------------------------------------
  // üîß CONFIG √Ä REMPLACER
  // --------------------------------------------------------
  const SUPABASE_URL = "https://xxxxx.supabase.co";   // ‚Üê Ton URL Supabase
  const SUPABASE_ANON_KEY = "xxxxx";                 // ‚Üê Cl√© anon publique
  const FUNCTION_URL =
    "https://xxxxx.functions.supabase.co/support-notify"; // ‚Üê URL de ta Edge Function


  // --------------------------------------------------------
  // üîå INITIALISATION
  // --------------------------------------------------------
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById("support-form");
  const statusEl = document.getElementById("status");


  // --------------------------------------------------------
  // üì§ TRAITEMENT DU FORMULAIRE
  // --------------------------------------------------------
  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    statusEl.textContent = "Enregistrement...";

    const formData = new FormData(form);

    const payload = {
      last_name: formData.get("last_name"),
      first_name: formData.get("first_name"),
      address: formData.get("address"),
      phone: formData.get("phone"),
      email: formData.get("email"),
      public_name: formData.get("public_name") === "yes",
      signature: formData.get("signature"),
    };

    // ----------------------------------------------
    // 1Ô∏è‚É£ INSERTION DANS SUPABASE
    // ----------------------------------------------
    const { error } = await supabase
      .from("support_committee_members")
      .insert(payload);

    if (error) {
      console.error(error);
      statusEl.textContent =
        "‚ùå Erreur lors de l‚Äôenregistrement. Merci de r√©essayer.";
      return;
    }

    // ----------------------------------------------
    // 2Ô∏è‚É£ ENVOI EMAIL VIA EDGE FUNCTION
    // ----------------------------------------------
    const res = await fetch(FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      console.error(await res.text());
      statusEl.textContent =
        "‚ö†Ô∏è Enregistr√©, mais l'email de notification n'a pas pu √™tre envoy√©.";
      return;
    }

    // ----------------------------------------------
    // ‚úîÔ∏è SUCC√àS
    // ----------------------------------------------
    statusEl.textContent = "üéâ Merci ! Votre soutien a bien √©t√© enregistr√©.";
    form.reset();
  });
</script>

</body>
</html>
